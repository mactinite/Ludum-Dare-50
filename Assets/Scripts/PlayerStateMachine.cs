using System;
using System.Collections;
using System.Collections.Generic;
using System.Collections.Specialized;
using mactinite.EDS.Basic;
using mactinite.ToolboxCommons;
using UnityEngine;
using UnityEngine.Serialization;

public class PlayerStateMachine : StateMachine<PlayerStateMachine>
{

    public HealthBarController healthBarController;
    
    public SoundBox punchWooshSounds;
    public SoundBox punchUpSounds;
    public SoundBox punchSlamSounds;


    
    public float punchDuration = 0.5f;
    public float punchForwardSpeed = 10f;
    public float punchHitboxActivateTime = 0.25f;
    public float punchDistance = 1f;
    [SerializeField] public AnimationCurve punchAnimationTiming;
    public GameObject punchHitbox;

    
    public float kickDuration = 0.5f;
    public float kickUpwardSpeed = 10f;
    public float kickDownwardSpeed = 10f;
    public float kickHitboxActivateTime = 0.25f;
    public float kickHeight = 4f;
    public GameObject kickUpHitbox;
    public GameObject kickDownHitbox;
    public float airKickRecoveryTime = 0.2f;

    
    [SerializeField]
    public ActionCharacterController characterController;

    [SerializeField] internal Animator animator;

    public BasicDamageReceiver damageReceiver;

    public Transform deathPrefab;



    public ActionCharacterController CharacterController
    {
        get => characterController;
        set => characterController = value;
    }

    public float dashSpeed = 10f;

    public float dashDuration = 0.5f;

    public float stunDuration = 0.2f;


    private void Start()
    {
        damageReceiver.OnDamage += OnDamage;
        damageReceiver.OnDestroyed += OnDeath;

        StateMap.Add("Ground",  new GroundState(this));
        StateMap.Add("Air",  new AirState(this));
        StateMap.Add("Punch",  new PunchState(this, "Punch", "Punch 2"));
        StateMap.Add("Punch 2",  new PunchState(this, "Punch 2", "Punch"));
        StateMap.Add("Kick",  new KickState(this));
        StateMap.Add("AirKick",  new AirKickState(this));
        StateMap.Add("Stun",  new PlayerStunState(this));
        StateMap.Add("Dash",  new DashState(this));
        SetState("Ground");
    }

    private void OnDeath(Vector2 pos)
    {
        gameObject.SetActive(false);
        Instantiate(deathPrefab, transform.position, transform.rotation);
        Debug.Log("Game Over");
    }

    private void OnDamage(Vector2 pos, BasicDamage damage)
    {
        healthBarController.SetValue(damage.NewHealth / damageReceiver.maxHealth);   
    }
}

public class PlayerStunState : State<PlayerStateMachine>
{
    public PlayerStunState(PlayerStateMachine stateMachine) : base(stateMachine)
    {
    }

    public override IEnumerator Start()
    {
        float t = 0;
        StateMachine.animator.Play("Stun");
        StateMachine.CharacterController.canControl = false;
        StateMachine.CharacterController.movement.useGravity = false;
        yield return new WaitForSeconds(StateMachine.stunDuration);
        StateMachine.CharacterController.canControl = true;
        StateMachine.CharacterController.movement.useGravity = true;
        StateMachine.SetState("Ground");
    }
}


public class GroundState : State<PlayerStateMachine>
{
    public GroundState(PlayerStateMachine stateMachine) : base(stateMachine)
    {
        
    }

    public GroundState()
    {
    }

    public override IEnumerator Start()
    {
        // Allow movement and ground attacks
        while (StateMachine.CharacterController.isGrounded)
        {
            if (StateMachine.CharacterController.movement.forwardSpeed > 0)
            {
                StateMachine.animator.Play("Walk");
            }
            else
            {
                StateMachine.animator.Play("Idle");
            }
            
            // transition to ground attack states, punch & kick
            if (StateMachine.CharacterController.input.actions["Punch"].triggered)
            {
                StateMachine.SetState("Punch");
                yield break;
            }
            
            if (StateMachine.CharacterController.input.actions["Kick"].triggered)
            {
                StateMachine.SetState("Kick");
                yield break;
            }
            
            if (StateMachine.CharacterController.input.actions["Dash"].triggered)
            {
                StateMachine.SetState("Dash");
                yield break;
            }

            if (StateMachine.damageReceiver.wasDamagedThisFrame)
            {
                StateMachine.SetState("Stun");
                yield break;
            }
            
            yield return null;
        }

        StateMachine.SetState("Air");
    }
    
}

public class AirState : State<PlayerStateMachine>
{
    
    public AirState(PlayerStateMachine stateMachine) : base(stateMachine)
    {
    }

    public AirState()
    {
    }

    public override IEnumerator Start()
    {
        
        // Allow air movement and air attacks
        while (!this.StateMachine.CharacterController.isGrounded)
        {

            if (StateMachine.CharacterController.movement.velocity.y > 0)
            {
                StateMachine.animator.Play("Jump");
            }
            else
            {
                StateMachine.animator.Play("Fall");
            }
            
            if (StateMachine.damageReceiver.wasDamagedThisFrame)
            {
                StateMachine.SetState("Stun");
                yield break;
            }
            
            // transition to air attack states, punch & kick
            if (StateMachine.CharacterController.input.actions["Punch"].triggered)
            {
                StateMachine.SetState("Punch");
                yield break;
            }
            
            if (StateMachine.CharacterController.input.actions["Kick"].triggered)
            {
                StateMachine.SetState("AirKick");
                yield break;
            }
            
            if (StateMachine.CharacterController.input.actions["Dash"].triggered)
            {
                StateMachine.SetState("Dash");
                yield break;
            }
            


            yield return null;
        }
        StateMachine.SetState("Ground");
    }
}

public class PunchState : State<PlayerStateMachine>
{
    private string animation;
    private string nextAnimationState;
    public PunchState(PlayerStateMachine stateMachine, string animationState, string nextAnimationState) : base(stateMachine)
    {
        this.animation = animationState;
        this.nextAnimationState = nextAnimationState;
    }

    public PunchState()
    {
    }

    public override IEnumerator Start()
    {
        float t = 0;
        bool nextComboBuffered = false;
        StateMachine.CharacterController.canControl = false;
        StateMachine.CharacterController.movement.useGravity = false;
        StateMachine.CharacterController.movement.velocity = Vector3.zero;
        
        Vector3 startPosition = StateMachine.CharacterController.transform.position;
        StateMachine.animator.Play(animation);
        StateMachine.punchWooshSounds.PlayRandomOneShot();
        while (t <= StateMachine.punchDuration)
        {
            
            if (StateMachine.damageReceiver.wasDamagedThisFrame)
            {
                StateMachine.punchHitbox.SetActive(false);
                StateMachine.CharacterController.movement.velocity = Vector3.zero;
                StateMachine.SetState("Stun");
                yield break;
            }
            
            if (t > 0 && StateMachine.CharacterController.input.actions["Punch"].triggered)
            {
                nextComboBuffered = true;
            }

            if (t > StateMachine.punchHitboxActivateTime)
            {
                StateMachine.punchHitbox.SetActive(true);
            }
            
            float evaluatedT = StateMachine.punchAnimationTiming.Evaluate(Mathf.Clamp01(t / StateMachine.punchDuration));
            // StateMachine.transform.position = Vector3.Lerp(startPosition, startPosition + (StateMachine.transform.forward * StateMachine.punchForwardSpeed), evaluatedT);
            float speed = Mathf.Lerp(0, StateMachine.punchForwardSpeed, evaluatedT);
            StateMachine.characterController.movement.Move(StateMachine.transform.forward * speed, StateMachine.punchForwardSpeed);
            t += Time.deltaTime;
            yield return null;
        }


        if (nextComboBuffered)
        {
            StateMachine.SetState(nextAnimationState);
        }
        else
        {
            StateMachine.SetState("Ground");
        }
        
        StateMachine.CharacterController.canControl = true;
        StateMachine.CharacterController.movement.useGravity = true;
        StateMachine.CharacterController.movement.velocity = Vector3.zero;
        
        StateMachine.punchHitbox.SetActive(false);

        
    }

}


public class KickState : State<PlayerStateMachine>
{
    public KickState(PlayerStateMachine stateMachine) : base(stateMachine)
    {
    }

    public KickState()
    {
    }

    public override IEnumerator Start()
    {
        float t = 0;
        float maxHeight = StateMachine.transform.position.y + StateMachine.kickHeight;
        StateMachine.CharacterController.canControl = false;
        StateMachine.CharacterController.movement.velocity = Vector3.zero;
        StateMachine.animator.Play("Punch Up");
        StateMachine.punchUpSounds.PlayRandomOneShot();

        while (t < StateMachine.kickDuration || StateMachine.transform.position.y < maxHeight)
        {
            StateMachine.CharacterController.movement.ApplyVerticalImpulse(StateMachine.kickUpwardSpeed);
            StateMachine.CharacterController.movement.DisableGrounding();

            if (t > StateMachine.kickHitboxActivateTime)
            {
                StateMachine.kickUpHitbox.SetActive(true);
            }
            
            t += Time.deltaTime;
            yield return null;
        }
        
        StateMachine.CharacterController.canControl = true;
        StateMachine.kickUpHitbox.SetActive(false);
        StateMachine.SetState("Air");
    }
}

public class AirKickState : State<PlayerStateMachine>
{
    public AirKickState(PlayerStateMachine stateMachine) : base(stateMachine)
    {
    }

    public AirKickState()
    {
    }

    public override IEnumerator Start()
    {
        float t = 0;
        StateMachine.CharacterController.movement.useGravity = false;
        StateMachine.CharacterController.canControl = false;
        StateMachine.animator.Play("Slam");
        StateMachine.punchUpSounds.PlayRandomOneShot();

        while (!StateMachine.CharacterController.isGrounded)
        {
            if (t > StateMachine.kickHitboxActivateTime)
            {
                StateMachine.kickDownHitbox.SetActive(true);
            }
            StateMachine.CharacterController.movement.ApplyImpulse(-(StateMachine.transform.up) * StateMachine.kickDownwardSpeed);
            t += Time.deltaTime;
            yield return null;
        }
        StateMachine.punchSlamSounds.PlayRandomOneShot();

        yield return new WaitForSeconds(StateMachine.airKickRecoveryTime);
        
        StateMachine.CharacterController.movement.useGravity = true;
        StateMachine.CharacterController.canControl = true;
        StateMachine.kickDownHitbox.SetActive(false);

        StateMachine.SetState("Ground");
    }
}

public class DashState : State<PlayerStateMachine>
{
    public DashState(PlayerStateMachine stateMachine) : base(stateMachine)
    {
    }

    public override IEnumerator Start()
    {
        float t = 0;
        StateMachine.damageReceiver.enabled = false;
        StateMachine.CharacterController.canControl = false;
        StateMachine.CharacterController.movement.velocity = Vector3.zero;
        StateMachine.animator.Play("Dash");
        
        while (t < StateMachine.dashDuration)
        {
            StateMachine.characterController.movement.Move(StateMachine.transform.forward * StateMachine.dashSpeed, StateMachine.dashSpeed);
            t += Time.deltaTime;
            yield return null;
        }
        
        StateMachine.damageReceiver.enabled = true;
        StateMachine.CharacterController.canControl = true;
        
        StateMachine.SetState("Ground");
    }
}


